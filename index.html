<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="Cross-Origin-Opener-Policy" content="same-origin">
  <meta http-equiv="Cross-Origin-Embedder-Policy" content="require-corp">
  <title>Magic Lantern HDR Video Merger</title>
  <script src="https://cdn.jsdelivr.net/npm/@ffmpeg/ffmpeg@0.11.0/dist/ffmpeg.min.js"></script>
</head>
<body>
  <h1>Magic Lantern HDR Video Merger</h1>
  <input type="file" id="videoInput" accept="video/*">
  <button onclick="processHDR()">Process HDR</button>
  <div id="output"></div>

  <script>
    const { createFFmpeg, fetchFile } = FFmpeg;

    const ffmpeg = createFFmpeg({ log: true });
    let frameData = [];

    async function processHDR() {
      const videoInput = document.getElementById('videoInput').files[0];
      if (!videoInput) {
        alert('Please select a video file!');
        return;
      }

      // Load ffmpeg
      if (!ffmpeg.isLoaded()) await ffmpeg.load();

      // Write the video file to ffmpeg's filesystem
      ffmpeg.FS('writeFile', 'input.mp4', await fetchFile(videoInput));

      // Extract frames (every frame as an image)
      await ffmpeg.run('-i', 'input.mp4', '-vf', 'fps=1', 'frame%d.png');

      // Read the generated frames
      const files = ffmpeg.FS('readdir', '/');
      const frameFiles = files.filter(fn => fn.match(/frame\d+\.png/));

      // Separate frames into even and odd indices
      frameData = [];
      frameFiles.forEach((file, index) => {
        const frameNum = parseInt(file.match(/\d+/)[0]);
        if (frameNum % 2 === 0) {
          frameData.push({ type: 'even', file, data: ffmpeg.FS('readFile', file) });
        } else {
          frameData.push({ type: 'odd', file, data: ffmpeg.FS('readFile', file) });
        }
      });

      // Display result (for now, just log)
      const output = document.getElementById('output');
      output.innerHTML = `Separated ${frameData.length} frames: ${frameData.filter(f => f.type === 'even').length} even, ${frameData.filter(f => f.type === 'odd').length} odd`;
    }
  </script>
</body>
</html>
